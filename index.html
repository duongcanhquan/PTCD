<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng Theo D√µi 9+</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root { --primary-color: #0056b3; --bg-color: #f0f4f8; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--bg-color); min-height: 100vh; padding-bottom: 80px;}
        .app-container { max-width: 600px; margin: 0 auto; }
        .header-section { text-align: center; padding: 30px 20px 20px; }
        .logo-img { width: 80px; margin-bottom: 10px; }
        .main-card { border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: none; overflow: hidden; margin: 0 15px; background: white; }
        .nav-tabs .nav-link.active { background-color: white; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 600; border: none; padding: 15px; }
        .btn-submit { background: linear-gradient(45deg, #0056b3, #004494); border: none; border-radius: 12px; padding: 12px; font-weight: 700; color: white; }
        .search-item { cursor: pointer; transition: background 0.2s; }
        .search-item:hover { background-color: #f8f9fa; }
        .status-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header-section">
        <img src="https://raw.githubusercontent.com/duongcanhquan/image/main/logo%20vietmy.webp" alt="Logo" class="logo-img">
        <h5 class="fw-bold text-primary">QU·∫¢N L√ù K·ª∂ LU·∫¨T H·ªåC SINH</h5>
    </div>

    <div class="card main-card">
        <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#report-pane">üìù B√°o C√°o</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search-pane">üîç Tra C·ª©u</button></li>
        </ul>

        <div class="card-body p-3">
            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="report-pane">
                    <form id="incidentForm">
                        <div class="row g-2 mb-3">
                            <div class="col-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" name="student_name" placeholder="T√™n HS" required>
                                    <label>H·ªç v√† T√™n H·ªçc Sinh</label>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" name="class_name" placeholder="L·ªõp" required>
                                    <label>L·ªõp</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-floating mb-3">
                            <select class="form-select" name="violation_type">
                                <option value="ƒêi mu·ªôn" selected>‚è∞ ƒêi mu·ªôn / Trang ph·ª•c</option>
                                <option value="ƒê√°nh nhau">üí• ƒê√°nh nhau / G√¢y g·ªï</option>
                                <option value="H√∫t thu·ªëc">üö¨ H√∫t thu·ªëc l√°</option>
                                <option value="V√¥ l·ªÖ">ü§¨ V√¥ l·ªÖ v·ªõi GV</option>
                                <option value="S·ª≠ d·ª•ng ƒêT">üì± S·ª≠ d·ª•ng ƒëi·ªán tho·∫°i</option>
                                <option value="Kh√°c">üìù L·ªói kh√°c</option>
                            </select>
                            <label>H√†nh Vi Vi Ph·∫°m</label>
                        </div>

                        <div class="form-floating mb-3">
                            <textarea class="form-control" name="description" style="height: 100px" placeholder="Chi ti·∫øt" required></textarea>
                            <label>Chi ti·∫øt s·ª± vi·ªác & L√Ω do</label>
                        </div>

                        <div class="mb-3 border p-2 rounded bg-light">
                            <label class="small text-muted mb-1">üì∏ ·∫¢nh b·∫±ng ch·ª©ng:</label>
                            <input type="file" class="form-control" name="data" accept="image/*" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-submit" id="btnSubmit">G·ª¨I B√ÅO C√ÅO</button>
                    </form>
                    <div id="reportMsg" class="alert mt-3 text-center" style="display:none;"></div>
                </div>

                <div class="tab-pane fade" id="search-pane">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="searchName" placeholder="Nh·∫≠p t√™n h·ªçc sinh...">
                        <button class="btn btn-primary" onclick="searchStudent()">T√¨m</button>
                    </div>

                    <div id="searchLoading" class="text-center py-3 d-none">
                        <div class="spinner-border text-primary spinner-border-sm"></div> ƒêang t√¨m ki·∫øm...
                    </div>

                    <div id="searchResult"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="closeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title fw-bold">X√°c nh·∫≠n x·ª≠ l√Ω vi ph·∫°m?</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formClose">
                    <input type="hidden" name="case_id" id="modalCaseId">
                    <input type="hidden" name="student_id" id="modalStudentId"> <p class="small text-muted mb-2">ƒêang x·ª≠ l√Ω h·ªì s∆°: <b id="displayCaseId" class="text-primary">...</b></p>
                    
                    <div class="mb-3">
                        <textarea class="form-control" name="note" placeholder="Ghi ch√∫ x·ª≠ l√Ω (VD: ƒê√£ vi·∫øt b·∫£n ki·ªÉm ƒëi·ªÉm, ƒê√£ g·ªçi PH...)" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="small text-muted mb-1">üì∏ ·∫¢nh Bi√™n b·∫£n / Cam k·∫øt (B·∫Øt bu·ªôc):</label>
                        <input type="file" class="form-control" name="data" accept="image/*" required>
                    </div>

                    <button type="submit" class="btn btn-success w-100 fw-bold" id="btnClose">C·∫¨P NH·∫¨T ƒê√É XONG</button>
                </form>
                <div id="msgClose" class="alert mt-2 d-none small"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ‚ö†Ô∏è QUAN TR·ªåNG: D√ÅN LINK WEBHOOK C·ª¶A B·∫†N V√ÄO ƒê√ÇY
    // D√πng link Test (ƒë·ªÉ hi·ªán d·ªØ li·ªáu trong Editor) ho·∫∑c link Production (ƒë·ªÉ ch·∫°y th·∫≠t)
    const WEBHOOK_URL = 'https://apchn-host.lapage.vn/webhook/incident-api'; 

    // --- 1. X·ª¨ L√ù G·ª¨I B√ÅO C√ÅO ---
    const formReport = document.getElementById('incidentForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const reportMsg = document.getElementById('reportMsg');

    formReport.addEventListener('submit', async function(e) {
        e.preventDefault();
        handleFormSubmit(formReport, btnSubmit, 'report', reportMsg, "G·ª¨I B√ÅO C√ÅO");
    });

    // --- 2. X·ª¨ L√ù ƒê√ìNG H·ªí S∆† (CLOSE CASE) ---
    const formClose = document.getElementById('formClose');
    const btnClose = document.getElementById('btnClose');
    const msgClose = document.getElementById('msgClose');

    formClose.addEventListener('submit', async function(e) {
        e.preventDefault();
        // action="close_case" kh·ªõp v·ªõi nh√°nh 3 trong n8n
        await handleFormSubmit(formClose, btnClose, 'close_case', msgClose, "C·∫¨P NH·∫¨T ƒê√É XONG");
        
        // N·∫øu th√†nh c√¥ng th√¨ reload l·∫°i t√¨m ki·∫øm sau 1.5s ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
        if(msgClose.classList.contains('alert-success')) {
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('closeModal')).hide();
                searchStudent(); // Load l·∫°i danh s√°ch
                msgClose.classList.add('d-none'); // Reset th√¥ng b√°o modal
                formClose.reset();
            }, 1500);
        }
    });

    // --- H√ÄM G·ª¨I FORM CHUNG (Cho g·ªçn code) ---
    async function handleFormSubmit(formEl, btnEl, actionName, msgEl, defaultBtnText) {
        btnEl.disabled = true; 
        btnEl.innerText = "ƒêang x·ª≠ l√Ω...";
        msgEl.style.display = 'none';

        const formData = new FormData(formEl);
        formData.append("action", actionName);

        try {
            const res = await fetch(WEBHOOK_URL, { method: 'POST', body: formData });
            const data = await res.json();

            msgEl.style.display = 'block';
            if (data.success) {
                msgEl.className = 'alert alert-success mt-2';
                msgEl.innerHTML = `‚úÖ ${data.message}`;
                if(actionName === 'report') formEl.reset(); // Ch·ªâ reset form b√°o c√°o ngay
            } else {
                msgEl.className = 'alert alert-danger mt-2';
                msgEl.innerHTML = `‚ùå ${data.message}`;
            }
        } catch (err) {
            msgEl.style.display = 'block';
            msgEl.className = 'alert alert-danger mt-2';
            msgEl.innerText = "L·ªói k·∫øt n·ªëi: " + err.message;
        } finally {
            btnEl.disabled = false; 
            btnEl.innerText = defaultBtnText;
        }
    }

    // --- 3. TRA C·ª®U H·ªåC SINH ---
    async function searchStudent() {
        const name = document.getElementById('searchName').value.trim();
        if(!name) return;

        document.getElementById('searchLoading').classList.remove('d-none');
        document.getElementById('searchResult').innerHTML = '';

        const formData = new FormData();
        formData.append("action", "search");
        formData.append("student_name", name);

        try {
            const res = await fetch(WEBHOOK_URL, { method: 'POST', body: formData });
            const data = await res.json();
            renderSearchResults(data);
        } catch (err) {
            alert("L·ªói: " + err.message);
        } finally {
            document.getElementById('searchLoading').classList.add('d-none');
        }
    }

    function renderSearchResults(data) {
        const container = document.getElementById('searchResult');
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="alert alert-warning text-center">Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†o.</div>';
            return;
        }

        let html = '';
        data.forEach(s => {
            // ƒê·∫øm s·ªë l·ªói ƒëang m·ªü
            const openErrors = s.history ? s.history.filter(h => h.status === 'OPEN').length : 0;
            const badge = openErrors > 0 
                ? `<span class="badge bg-danger">${openErrors} l·ªói c·∫ßn x·ª≠ l√Ω</span>`
                : `<span class="badge bg-success">H·∫°nh ki·ªÉm t·ªët</span>`;

            html += `
                <div class="card mb-2 search-item border">
                    <div class="card-body p-3" onclick="toggleHistory('${s.student_id}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-0 text-primary">${s.name}</h6>
                                <div class="small text-muted">${s.class_name} | ${s.student_id}</div>
                            </div>
                            ${badge}
                        </div>
                    </div>
                    
                    <div id="hist-${s.student_id}" class="bg-light border-top p-3" style="display:none;">
                        <h6 class="fw-bold small border-bottom pb-2">L·ªãch s·ª≠ vi ph·∫°m:</h6>
                        ${renderHistoryRows(s.history, s.student_id)}
                        
                        ${s.drive_folder_link ? 
                            `<div class="mt-2 text-center"><a href="${s.drive_folder_link}" target="_blank" class="btn btn-sm btn-outline-primary w-100">üìÇ Xem Folder ·∫¢nh G·ªëc</a></div>` 
                            : ''}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function renderHistoryRows(history, studentId) {
        if(!history || history.length === 0) return '<div class="small text-muted fst-italic">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>';
        
        let rows = '';
        history.forEach(h => {
            // N·∫øu tr·∫°ng th√°i l√† OPEN th√¨ hi·ªán n√∫t X·ª≠ l√Ω, n·∫øu DONE th√¨ hi·ªán ch·ªØ ƒê√£ xong
            const actionBtn = h.status === 'OPEN' 
                ? `<button class="btn btn-sm btn-success ms-2 py-0 px-2" style="font-size: 12px;" onclick="openCloseModal(event, '${h.case_id}', '${studentId}')">‚úÖ X·ª≠ l√Ω</button>`
                : `<span class="text-success fw-bold ms-2" style="font-size: 12px;">‚úî ƒê√£ xong</span>`;

            rows += `
                <div class="d-flex justify-content-between align-items-center small mb-2 border-bottom pb-1">
                    <div>
                        <div><b>${h.violation_type}</b> <span class="text-muted">(${new Date(h.created_at).toLocaleDateString('vi-VN')})</span></div>
                        <div class="text-muted fst-italic">${h.current_stage}</div>
                    </div>
                    <div class="text-end">
                        ${actionBtn}
                    </div>
                </div>`;
        });
        return rows;
    }

    function toggleHistory(id) {
        const el = document.getElementById(`hist-${id}`);
        // Ch·ªâ toggle n·∫øu kh√¥ng ph·∫£i ƒëang click v√†o n√∫t X·ª≠ l√Ω
        if(window.event.target.tagName !== 'BUTTON') {
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }
    }

    // M·ªü Modal X·ª≠ l√Ω
    function openCloseModal(e, caseId, studentId) {
        e.stopPropagation(); // NgƒÉn vi·ªác click n√∫t m√† l·∫°i ƒë√≥ng m·ªü c√°i accordion
        document.getElementById('modalCaseId').value = caseId;
        document.getElementById('modalStudentId').value = studentId;
        document.getElementById('displayCaseId').innerText = caseId;
        
        // Reset form modal
        document.getElementById('formClose').reset();
        document.getElementById('msgClose').className = 'd-none';

        new bootstrap.Modal(document.getElementById('closeModal')).show();
    }
</script>
</body>
</html>
