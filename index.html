<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng Theo D√µi 9+</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root { --primary-color: #0056b3; --bg-color: #f0f4f8; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--bg-color); min-height: 100vh; }
        .app-container { max-width: 600px; margin: 0 auto; padding-bottom: 50px; }
        .header-section { text-align: center; padding: 30px 20px 20px; }
        .logo-img { width: 100px; margin-bottom: 10px; }
        .main-card { border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: none; overflow: hidden; margin: 0 15px; background: white; }
        .nav-tabs .nav-link.active { background-color: white; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 600; border: none; padding: 15px; }
        .btn-submit { background: linear-gradient(45deg, #0056b3, #004494); border: none; border-radius: 12px; padding: 12px; font-weight: 700; color: white; }
        .search-item { cursor: pointer; transition: background 0.2s; }
        .search-item:hover { background-color: #f1f3f5; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header-section">
        <img src="https://raw.githubusercontent.com/duongcanhquan/image/main/logo%20vietmy.webp" alt="Logo" class="logo-img">
        <h4 class="fw-bold text-primary">H·ªÜ TH·ªêNG THEO D√ïI 9+</h4>
    </div>

    <div class="card main-card">
        <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#report-pane">üìù B√°o C√°o</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#search-pane">üîç Tra C·ª©u</button></li>
        </ul>

        <div class="card-body p-4">
            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="report-pane">
                    <form id="incidentForm">
                        <div class="row g-2 mb-3">
                            <div class="col-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" name="student_name" placeholder="T√™n HS" required>
                                    <label>H·ªç v√† T√™n H·ªçc Sinh</label>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" name="class_name" placeholder="L·ªõp" required>
                                    <label>L·ªõp</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-floating mb-3">
                            <select class="form-select" name="violation_type">
                                <option value="ƒêi mu·ªôn" selected>‚è∞ ƒêi mu·ªôn / Trang ph·ª•c</option>
                                <option value="ƒê√°nh nhau">üí• ƒê√°nh nhau / G√¢y g·ªï</option>
                                <option value="H√∫t thu·ªëc">üö¨ H√∫t thu·ªëc l√°</option>
                                <option value="V√¥ l·ªÖ">ü§¨ V√¥ l·ªÖ v·ªõi GV</option>
                                <option value="S·ª≠ d·ª•ng ƒêT">üì± S·ª≠ d·ª•ng ƒëi·ªán tho·∫°i</option>
                                <option value="Kh√°c">üìù L·ªói kh√°c</option>
                            </select>
                            <label>H√†nh Vi Vi Ph·∫°m</label>
                        </div>

                        <div class="form-floating mb-3">
                            <textarea class="form-control" name="description" style="height: 100px" placeholder="Chi ti·∫øt" required></textarea>
                            <label>Chi ti·∫øt s·ª± vi·ªác & L√Ω do</label>
                        </div>

                        <div class="mb-3 border p-2 rounded bg-light">
                            <label class="small text-muted mb-1">üì∏ ·∫¢nh/Bi√™n b·∫£n:</label>
                            <input type="file" class="form-control" name="data" accept="image/*" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-submit" id="btnSubmit">G·ª¨I B√ÅO C√ÅO</button>
                    </form>
                    <div id="reportMsg" class="alert mt-3 text-center" style="display:none;"></div>
                </div>

                <div class="tab-pane fade" id="search-pane">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="searchName" placeholder="Nh·∫≠p t√™n h·ªçc sinh...">
                        <button class="btn btn-primary" onclick="searchStudent()">T√¨m</button>
                    </div>

                    <div id="searchLoading" class="text-center py-3 d-none">
                        <div class="spinner-border text-primary spinner-border-sm"></div> ƒêang t√¨m ki·∫øm...
                    </div>

                    <div id="searchResult"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ‚ö†Ô∏è D√ÅN WEBHOOK C·ª¶A B·∫†N V√ÄO ƒê√ÇY
    const WEBHOOK_URL = 'https://apchn-host.lapage.vn/webhook-test/incident-api'; 

    // --- X·ª¨ L√ù B√ÅO C√ÅO ---
    const form = document.getElementById('incidentForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const reportMsg = document.getElementById('reportMsg');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        btnSubmit.disabled = true; btnSubmit.innerText = "ƒêang x·ª≠ l√Ω...";
        
        const formData = new FormData(form);
        formData.append("action", "report"); 

        try {
            const res = await fetch(WEBHOOK_URL, { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success) {
                reportMsg.className = 'alert alert-success';
                reportMsg.innerHTML = `‚úÖ ${data.message}`;
                form.reset();
            } else {
                reportMsg.className = 'alert alert-danger';
                reportMsg.innerHTML = `‚ùå ${data.message}`; // Hi·ªán l·ªói n·∫øu sai t√™n/l·ªõp
            }
            reportMsg.style.display = 'block';
        } catch (err) {
            alert("L·ªói k·∫øt n·ªëi: " + err.message);
        } finally {
            btnSubmit.disabled = false; btnSubmit.innerText = "G·ª¨I B√ÅO C√ÅO";
        }
    });

    // --- X·ª¨ L√ù TRA C·ª®U ---
    async function searchStudent() {
        const name = document.getElementById('searchName').value.trim();
        if(!name) return alert("Vui l√≤ng nh·∫≠p t√™n!");

        document.getElementById('searchLoading').classList.remove('d-none');
        document.getElementById('searchResult').innerHTML = '';

        const formData = new FormData();
        formData.append("action", "search");
        formData.append("student_name", name);

        try {
            const res = await fetch(WEBHOOK_URL, { method: 'POST', body: formData });
            const data = await res.json();
            renderSearchResults(data);
        } catch (err) {
            alert("L·ªói: " + err.message);
        } finally {
            document.getElementById('searchLoading').classList.add('d-none');
        }
    }

    function renderSearchResults(data) {
        const container = document.getElementById('searchResult');
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="alert alert-warning text-center">Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†o.</div>';
            return;
        }

        let html = '<p class="small text-muted mb-2">Ch·ªçn h·ªçc sinh ƒë·ªÉ xem chi ti·∫øt:</p>';
        
        data.forEach(student => {
            // M√†u s·∫Øc tr·∫°ng th√°i vi ph·∫°m
            let statusBadge = '';
            if(student.history && student.history.length > 0) {
                const openCases = student.history.filter(h => h.status === 'OPEN').length;
                if(openCases > 0) statusBadge = `<span class="badge bg-danger ms-2">${openCases} vi ph·∫°m ch∆∞a x·ª≠ l√Ω</span>`;
                else statusBadge = `<span class="badge bg-success ms-2">H·∫°nh ki·ªÉm t·ªët</span>`;
            } else {
                statusBadge = `<span class="badge bg-success ms-2">Ch∆∞a c√≥ vi ph·∫°m</span>`;
            }

            // Hi·ªÉn th·ªã t·ª´ng h·ªçc sinh t√¨m ƒë∆∞·ª£c
            html += `
                <div class="card mb-2 search-item border" onclick="toggleHistory('${student.student_id}')">
                    <div class="card-body p-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-0 text-primary">${student.name}</h6>
                            <div class="small text-muted">L·ªõp: <b>${student.class_name}</b> | M√£: ${student.student_id}</div>
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div id="hist-${student.student_id}" class="bg-light border-top p-3" style="display:none;">
                         <h6 class="fw-bold small border-bottom pb-2">L·ªãch s·ª≠ ghi nh·∫≠n:</h6>
                         ${renderHistoryTable(student.history)}
                         ${student.drive_folder_link ? `<a href="${student.drive_folder_link}" target="_blank" class="btn btn-sm btn-outline-primary mt-2 w-100">üìÇ Xem Folder ·∫¢nh</a>` : ''}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function renderHistoryTable(history) {
        if(!history || history.length === 0) return '<div class="small text-muted fst-italic">Ch∆∞a c√≥ d·ªØ li·ªáu vi ph·∫°m.</div>';
        
        let rows = '';
        history.forEach(h => {
             rows += `
                <div class="d-flex justify-content-between small mb-2 border-bottom pb-1">
                    <span>${new Date(h.created_at).toLocaleDateString('vi-VN')} - <b>${h.violation_type}</b></span>
                    <span class="${h.status === 'OPEN' ? 'text-danger fw-bold' : 'text-success'}">${h.status === 'OPEN' ? h.current_stage : 'ƒê√£ xong'}</span>
                </div>`;
        });
        return rows;
    }

    function toggleHistory(id) {
        const el = document.getElementById(`hist-${id}`);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
</script>
</body>
</html>
