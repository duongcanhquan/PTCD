<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng Theo D√µi 9+</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #0056b3; /* M√†u xanh ƒë·∫≠m th∆∞∆°ng hi·ªáu */
            --accent-color: #ffc107;  /* M√†u v√†ng nh·∫•n */
            --bg-color: #f0f4f8;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            background-image: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            min-height: 100vh;
        }

        .app-container {
            max-width: 600px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông gi·ªëng app ƒëi·ªán tho·∫°i */
            margin: 0 auto;
            padding-bottom: 50px;
        }

        /* LOGO & HEADER */
        .header-section {
            text-align: center;
            padding: 30px 20px 20px;
        }
        .logo-img {
            width: 100px;
            height: auto;
            margin-bottom: 10px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        .app-title {
            font-weight: 800;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0;
            font-size: 1.5rem;
        }
        .app-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* CARD GIAO DI·ªÜN */
        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: none;
            overflow: hidden;
            margin: 0 15px;
        }

        /* TABS */
        .nav-tabs {
            border-bottom: none;
            background-color: #f8f9fa;
            padding: 10px 10px 0;
        }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 12px 12px 0 0;
            color: #6c757d;
            font-weight: 600;
            padding: 12px 20px;
            transition: all 0.3s;
        }
        .nav-tabs .nav-link.active {
            background-color: white;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
        }

        /* FORM ELEMENTS */
        .form-floating > .form-control:focus, 
        .form-floating > .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(0, 86, 179, 0.15);
        }
        
        .btn-submit {
            background: linear-gradient(45deg, #0056b3, #004494);
            border: none;
            border-radius: 12px;
            padding: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 86, 179, 0.3);
            transition: transform 0.2s;
        }
        .btn-submit:active {
            transform: scale(0.98);
        }

        /* K·∫æT QU·∫¢ TRA C·ª®U */
        .search-result-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            border-left: 5px solid var(--primary-color);
        }
        .badge-violation {
            font-size: 0.85em;
            padding: 6px 10px;
            border-radius: 8px;
        }
        
        /* FILE INPUT CUSTOM */
        .file-upload-wrapper {
            position: relative;
            height: 50px;
            border: 2px dashed #ced4da;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            transition: border 0.3s;
        }
        .file-upload-wrapper:hover {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }
        .file-upload-text {
            color: #6c757d;
            pointer-events: none;
        }
        .form-control[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

    </style>
</head>
<body>

<div class="app-container">
    <div class="header-section">
        <img src="https://raw.githubusercontent.com/duongcanhquan/image/main/logo%20vietmy.webp" alt="Logo VietMy" class="logo-img">
        <h1 class="app-title">H·ªÜ TH·ªêNG THEO D√ïI 9+</h1>
        <p class="app-subtitle">Qu·∫£n l√Ω n·ªÅ n·∫øp & K·ª∑ lu·∫≠t h·ªçc sinh</p>
    </div>

    <div class="card main-card">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item w-50 text-center" role="presentation">
                <button class="nav-link active w-100" id="report-tab" data-bs-toggle="tab" data-bs-target="#report-pane">
                    <i class="bi bi-pencil-square"></i> B√°o C√°o
                </button>
            </li>
            <li class="nav-item w-50 text-center" role="presentation">
                <button class="nav-link w-100" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane">
                    <i class="bi bi-search"></i> Tra C·ª©u
                </button>
            </li>
        </ul>

        <div class="card-body p-4">
            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="report-pane">
                    <form id="incidentForm">
                        
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="studentId" name="student_id" placeholder="HS001" required>
                            <label for="studentId">M√£ H·ªçc Sinh (VD: HS001)</label>
                        </div>

                        <div class="form-floating mb-3">
                            <select class="form-select" id="violationType" name="violation_type" aria-label="Lo·∫°i l·ªói">
                                <option value="ƒêi mu·ªôn" selected>‚è∞ ƒêi mu·ªôn / Sai ƒë·ªìng ph·ª•c</option>
                                <option value="ƒê√°nh nhau">üí• ƒê√°nh nhau / G√¢y g·ªï</option>
                                <option value="H√∫t thu·ªëc">üö¨ H√∫t thu·ªëc l√°</option>
                                <option value="V√¥ l·ªÖ">ü§¨ V√¥ l·ªÖ v·ªõi gi√°o vi√™n</option>
                                <option value="S·ª≠ d·ª•ng ƒêT">üì± S·ª≠ d·ª•ng ƒëi·ªán tho·∫°i</option>
                            </select>
                            <label for="violationType">Ch·ªçn H√†nh Vi Vi Ph·∫°m</label>
                        </div>

                        <div class="form-floating mb-3">
                            <textarea class="form-control" placeholder="M√¥ t·∫£" id="description" name="description" style="height: 100px" required></textarea>
                            <label for="description">Chi ti·∫øt s·ª± vi·ªác & L√Ω do...</label>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold text-secondary small">üì∏ ·∫¢nh minh ch·ª©ng / Bi√™n b·∫£n</label>
                            <div class="file-upload-wrapper">
                                <span class="file-upload-text" id="fileName"><i class="bi bi-cloud-upload"></i> Ch·∫°m ƒë·ªÉ ch·ªçn ·∫£nh</span>
                                <input type="file" class="form-control" name="data" accept="image/*" required onchange="updateFileName(this)">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-submit text-white" id="btnSubmit">
                            <i class="bi bi-send-fill"></i> G·ª¨I B√ÅO C√ÅO
                        </button>
                    </form>
                    
                    <div id="reportMsg" class="alert mt-3 text-center" style="display:none; border-radius: 12px;"></div>
                </div>

                <div class="tab-pane fade" id="search-pane">
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0" id="searchId" placeholder="Nh·∫≠p M√£ HS ƒë·ªÉ t√¨m...">
                        <button class="btn btn-primary" type="button" onclick="searchStudent()">T√¨m</button>
                    </div>

                    <div id="searchLoading" class="text-center py-4 text-muted" style="display:none;">
                        <div class="spinner-border text-primary spinner-border-sm" role="status"></div> ƒêang t·∫£i d·ªØ li·ªáu...
                    </div>

                    <div id="searchResult" style="display:none;">
                        </div>
                </div>

            </div>
        </div>
    </div>
    
    <div class="text-center mt-4 text-muted small">
        &copy; 2025 H·ªá Th·ªëng Qu·∫£n L√Ω Gi√°o D·ª•c 9+
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ‚ö†Ô∏è QUAN TR·ªåNG: Thay link Webhook c·ªßa b·∫°n v√†o ƒë√¢y
    const WEBHOOK_URL = 'https://apchn-host.lapage.vn/webhook-test/incident-api'; 

    // --- HI·ªÜU ·ª®NG T√äN FILE ---
    function updateFileName(input) {
        const fileNameSpan = document.getElementById('fileName');
        if (input.files && input.files.length > 0) {
            fileNameSpan.innerHTML = `<i class="bi bi-image"></i> ${input.files[0].name}`;
            fileNameSpan.style.color = '#0056b3';
            fileNameSpan.style.fontWeight = 'bold';
        } else {
            fileNameSpan.innerHTML = '<i class="bi bi-cloud-upload"></i> Ch·∫°m ƒë·ªÉ ch·ªçn ·∫£nh';
            fileNameSpan.style.color = '#6c757d';
        }
    }

    // --- LOGIC G·ª¨I B√ÅO C√ÅO ---
    const form = document.getElementById('incidentForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const reportMsg = document.getElementById('reportMsg');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Hi·ªáu ·ª©ng loading
        const originalBtnContent = btnSubmit.innerHTML;
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ƒêang g·ª≠i...`;
        reportMsg.style.display = 'none';

        const formData = new FormData(form);
        formData.append("action", "report"); 

        try {
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                reportMsg.className = 'alert alert-success';
                reportMsg.innerHTML = `<i class="bi bi-check-circle-fill"></i> G·ª≠i th√†nh c√¥ng!`;
                reportMsg.style.display = 'block';
                form.reset();
                updateFileName(document.querySelector('input[type=file]')); // Reset t√™n file
            } else {
                throw new Error("L·ªói k·∫øt n·ªëi Server");
            }
        } catch (error) {
            reportMsg.className = 'alert alert-danger';
            reportMsg.innerText = "‚ùå L·ªói: " + error.message;
            reportMsg.style.display = 'block';
        } finally {
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = originalBtnContent;
        }
    });

    // --- LOGIC TRA C·ª®U ---
    async function searchStudent() {
        const id = document.getElementById('searchId').value.trim();
        if(!id) return alert("Vui l√≤ng nh·∫≠p m√£ h·ªçc sinh!");

        const loading = document.getElementById('searchLoading');
        const resultArea = document.getElementById('searchResult');
        
        loading.style.display = 'block';
        resultArea.style.display = 'none';

        const formData = new FormData();
        formData.append("action", "search");
        formData.append("student_id", id);

        try {
            const res = await fetch(WEBHOOK_URL, { method: 'POST', body: formData });
            const data = await res.json();
            
            if(data.student_info && data.student_info.name) {
                const info = data.student_info;
                
                // Render HTML k·∫øt qu·∫£ ƒë·∫πp
                let historyHtml = '';
                const history = Array.isArray(data.history) ? data.history : (data.history ? [data.history] : []);

                if (history.length > 0 && history[0].case_id) {
                     history.forEach(item => {
                        let badgeColor = item.status === 'OPEN' ? 'bg-danger' : 'bg-success';
                        let statusText = item.status === 'OPEN' ? 'Ch∆∞a x·ª≠ l√Ω' : 'ƒê√£ xong';
                        
                        historyHtml += `
                            <div class="border-bottom py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-dark">${item.violation_type}</span>
                                    <span class="badge ${badgeColor}">${statusText}</span>
                                </div>
                                <div class="small text-muted mt-1">
                                    <i class="bi bi-clock"></i> ${new Date(item.created_at).toLocaleDateString('vi-VN')}
                                    &nbsp;|&nbsp; 
                                    <span class="text-warning fw-bold">${item.current_stage}</span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    historyHtml = '<div class="text-center text-muted py-3">Ch∆∞a c√≥ ghi nh·∫≠n vi ph·∫°m n√†o.</div>';
                }

                resultArea.innerHTML = `
                    <div class="search-result-card">
                        <h5 class="fw-bold text-primary mb-1">${info.name}</h5>
                        <p class="text-muted small mb-2">${info.class_name} | ${info.status}</p>
                        
                        ${info.drive_folder_link ? `<a href="${info.drive_folder_link}" target="_blank" class="btn btn-sm btn-outline-primary w-100 mb-3"><i class="bi bi-folder-symlink"></i> M·ªü H·ªì S∆° Drive</a>` : ''}
                        
                        <div class="bg-white p-3 rounded border">
                            <h6 class="fw-bold border-bottom pb-2 mb-2"><i class="bi bi-clock-history"></i> L·ªãch S·ª≠ Vi Ph·∫°m</h6>
                            ${historyHtml}
                        </div>
                    </div>
                `;
                resultArea.style.display = 'block';
            } else {
                resultArea.innerHTML = `<div class="alert alert-warning mt-3">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y h·ªçc sinh m√£ <b>${id}</b></div>`;
                resultArea.style.display = 'block';
            }

        } catch (err) {
            alert("L·ªói tra c·ª©u: " + err.message);
        } finally {
            loading.style.display = 'none';
        }
    }
</script>

</body>
</html>
